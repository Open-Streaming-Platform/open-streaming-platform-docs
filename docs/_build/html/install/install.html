<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation &mdash; Open Streaming Platform  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Upgrades" href="upgrades.html" />
    <link rel="prev" title="Attribution" href="../overview/attribution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Open Streaming Platform
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/about.html">About Open Streaming Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/repo.html">Repository Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/attribution.html">Attribution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#install-open-streaming-platform">Install Open Streaming Platform</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#script-install-single-server-osp-core-osp-rtmp-ejabberd-redis-mysql">Script Install - Single Server (OSP-Core, OSP-RTMP, Ejabberd, Redis, MySQL)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#script-install-split-server-install-osp-components-on-different-servers">Script Install - Split Server Install - OSP Components on Different Servers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#recommended-install-order">Recommended Install Order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#centralized-storage-mounting-use-with-osp-core-and-osp-rtmp"><strong>Centralized Storage Mounting (Use with OSP-Core and OSP-RTMP)</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ejabberd">Ejabberd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#redis">Redis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#database">Database</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osp-core">OSP-Core</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osp-rtmp">OSP-RTMP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osp-edge">OSP-Edge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osp-proxy">OSP-Proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#manual-install">Manual Install</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-install">Docker Install</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#added-in-beta-5a">Added in Beta 5a</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recommended-volumes-mount-points">Recommended Volumes/Mount Points</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#database-setup">Database Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#set-up-mysql">Set Up MySQL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#backup-and-restore">Backup and Restore</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#backup">Backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restore">Restore</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#migration">Migration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#moving-from-utf8-to-utf8mb4-in-mysql">Moving from UTF8 to UTF8MB4 in MySQL</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#chat-xmpp">Chat (XMPP)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#single-server">Single Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-server">External Server</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#network-configuration">Network Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#osp-configuration">OSP Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-options">User Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-controls">User Controls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mod-controls">Mod Controls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentication">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#two-way-integration-with-other-chat-clients">Two Way Integration with Other Chat Clients</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installation-osp">Installation - OSP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-matterbridge">Install Matterbridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manually-configuring-certificates-if-auto-creation-is-not-functioning">Manually configuring certificates if auto creation is not functioning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#let-s-encrypt-setup">Let’s Encrypt Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#haproxy-load-balancing">HAProxy Load Balancing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-config-file">Setup Config File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ssl-setup">SSL Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automatic-certificate-renewals-and-file-merging">Automatic Certificate Renewals and File Merging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lock-down-stats-page">Lock Down Stats Page</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="upgrades.html">Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="tweaks.html">Tweaks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/streaming.html">Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/channels.html">Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/uploadingvideo.html">Uploading Video</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/administrator.html">Administrator Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/oauth.html">OAuth Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/webhooks.html">Webhooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Services:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../services/proxy.html">OSP-Proxy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Open Streaming Platform</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Installation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/install/install.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h1>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline"></a></h2>
<p>OSP has been verified to work with the following requirements</p>
<ul class="simple">
<li><p>Ubuntu 18.04 or later, Debian 10 or later</p></li>
<li><p>Python 3.7 or later</p></li>
<li><p>MySQL 5.7.7 or later, or MariaDB &gt; 10.1, if not using SQLite</p></li>
<li><p>SMTP Mail Server for Email Address Validation and Subscriptions</p></li>
<li><p>FFMPEG 4 or greater</p></li>
<li><p>Dual Core Processor at 2.4 Ghz</p></li>
<li><p>4 GB RAM</p></li>
<li><p>120 GB HDD Storage</p></li>
<li><p>Upstream Bandwidth &gt; 35Mbps for 720p/30fps  Streams to 10 people &#64;  3500kbps bit rate</p></li>
</ul>
</section>
<section id="install-open-streaming-platform">
<h2>Install Open Streaming Platform<a class="headerlink" href="#install-open-streaming-platform" title="Permalink to this headline"></a></h2>
<section id="script-install-single-server-osp-core-osp-rtmp-ejabberd-redis-mysql">
<h3>Script Install - Single Server (OSP-Core, OSP-RTMP, Ejabberd, Redis, MySQL)<a class="headerlink" href="#script-install-single-server-osp-core-osp-rtmp-ejabberd-redis-mysql" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 1 - “Install OSP - Single Server”</p></li>
<li><p>During the install process, the Config Tool will ask for an Ejabberd Full Qualified Domain Name (FQDN). This should be the same as the public domain name which will be used to access OSP. This should be a valid DNS entry as it is used to configure Ejabberd’s Chat Domain and by default is used by the chat client to connect users to the XMPP chat system. IP addresses may not function properly.</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>Review the values in the OSP /opt/osp/conf/config.py.</p></li>
</ol>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> secretKey and passwordSalt should be changed from their default values.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /opt/osp/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Restart the OSP Core Workers</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart osp.target
</pre></div>
</div>
<p>To test streaming on the server, see the “Testing OSP server” section of the <span class="xref myst">Streaming</span> page.</p>
</section>
<section id="script-install-split-server-install-osp-components-on-different-servers">
<h3>Script Install - Split Server Install - OSP Components on Different Servers<a class="headerlink" href="#script-install-split-server-install-osp-components-on-different-servers" title="Permalink to this headline"></a></h3>
<p>Starting with OSP version 0.8.0, OSP components can be split over multiple servers. This helps with spreading the load required for a busy OSP install with many viewers. In addition, splitting the components can be useful to set up load balancing by having multiple copies of the component and using a load balancer, such as HAproxy.
To perform a Split Server Setup, please review the following requirements:</p>
<ul class="simple">
<li><p><strong>Componentaization</strong> - Multiple components can be installed on a single server to reduce cost. Doing so can also prevent needing some of the considerations in this list. For Example, if you consolidate OSP-Core and OSP-RTMP and do not require OSP-Edge Servers, you will not need Centralized storage as they</p></li>
<li><p><strong>Centralized Storage</strong> - OSP requires some form of mounted centralized storage for Videos, Clips, &amp; Stream/Video Thumbnails. This can be accomplished easily by using an S3-based storage bucket and using s3fs to mount the bucket to the servers file systems. Another method would be a NFS mount in the require location. Below is the required drive mounts and locations</p></li>
<li><p><strong>Mounts</strong></p></li>
<li><p>/var/www/videos - OSP-Core, OSP-RTMP</p></li>
<li><p>/var/www/stream-thumb - OSP-Core, OSP-RTMP</p></li>
<li><p>/var/www/images - OSP-Core</p></li>
<li><p><strong>SSL/TLS</strong> - If OSP Core systems use HTTPS with SSL/TLS certificates, certificates will also be needed for the Ejabberd, Edge, Proxy, or OSP-RTMP (Only if using Proxy) Servers to prevent issues with HTTP(s) mixed content.</p></li>
<li><p><strong>MySQL &amp; Redis</strong> - the OSP Config Tool does not have an option for MySQL and Redis installs. It is recommended to be familar with their install and configuration prior to a Split Server Install
In some instances, some services can be co-located on the same server. See rules below:</p></li>
<li><p>OSP-Core, OSP-RTMP, Redis, ejabberd, and Database can exist on the same server</p></li>
<li><p>OSP-Edge can not exist on the same server as OSP-RTMP</p></li>
<li><p>OSP-Proxy can not exist on the same server as OSP-Edge, OSP-Core, OSP-RTMP, or ejabberd</p></li>
</ul>
<section id="recommended-install-order">
<h4>Recommended Install Order<a class="headerlink" href="#recommended-install-order" title="Permalink to this headline"></a></h4>
<p>Below is the recommended order of setting up split servers. This is due to some of the dependancies requires for some servers to function properly.</p>
<ol class="arabic simple">
<li><p>Centralized Storage - Have a server ready to connect to</p></li>
<li><p>Ejabberd</p></li>
<li><p>Redis</p></li>
<li><p>Database</p></li>
<li><p>OSP-Core</p></li>
<li><p>OSP-RTMP</p></li>
<li><p>OSP-Edge</p></li>
<li><p>OSP-Proxy</p></li>
</ol>
</section>
<section id="centralized-storage-mounting-use-with-osp-core-and-osp-rtmp">
<h4><strong>Centralized Storage Mounting (Use with OSP-Core and OSP-RTMP)</strong><a class="headerlink" href="#centralized-storage-mounting-use-with-osp-core-and-osp-rtmp" title="Permalink to this headline"></a></h4>
<p>These instructions are intended to be used <strong>after the OSP-Core and OSP-RTMP install processes</strong>. After installing the OSP components, it is recommended to determine and establish a central storage server setup on completion of component deployment.
Due to the many possible configurations of using central, shared storage, it is impossible to cover a “best” method for doing so. For the purposes of this documentation, it is assumed that an S3-compatable bucket will be used and mounting is covered below using s3fs.
<strong>DO NOT USE s3fs 1.86-1.</strong>
<strong>A critical bug in caching can lead to mount failure of the s3 bucket, leading to loss of recordings. Currently the latest Ubuntu LTS (20.04) only has this version of s3fs available.</strong></p>
<ol class="arabic simple">
<li><p>Install s3fs</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get update <span class="o">&amp;&amp;</span> sudo apt-get install s3fs
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Create a password file. This will contain the S3 key and secret token:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> S3KEY:S3TOKEN &gt; ~/.passwd-s3fs
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Set the permissions to secure the file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod <span class="m">600</span> ~/.passwd-s3fs
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Edit the Fuse Configurations to allow access by non-root users to files</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /etc/fuse.conf
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Comment out the following line <code class="docutils literal notranslate"><span class="pre">user_allow_other</span></code></p></li>
<li><p>Identify and write down the uid and gid of the www-data user. Example: <code class="docutils literal notranslate"><span class="pre">uid=33(www-data)</span> <span class="pre">gid=33(www-data)</span> <span class="pre">groups=33(www-data)</span></code></p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo -u www-data id
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Create the required stub locations:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mkdir -p /var/www/videos
sudo mkdir -p /var/www/images
sudo mkdir -p /var/www/stream-thumb
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Mount the directories to the S3-compatible bucket using your S3 Credentials and the identified UID &amp; GID frm Step 6</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>s3fs &lt;space_name&gt; /var/www/videos -o <span class="nv">url</span><span class="o">=</span>&lt;s3 endpoint&gt; -o <span class="nv">use_cache</span><span class="o">=</span>/tmp -o allow_other -o use_path_request_style -o <span class="nv">uid</span><span class="o">=</span>&lt;UID&gt; -o <span class="nv">gid</span><span class="o">=</span>&lt;GID&gt;
s3fs &lt;space_name&gt; /var/www/images -o <span class="nv">url</span><span class="o">=</span>&lt;s3 endpoint&gt; -o <span class="nv">use_cache</span><span class="o">=</span>/tmp -o allow_other -o use_path_request_style -o <span class="nv">uid</span><span class="o">=</span>&lt;UID&gt; -o <span class="nv">gid</span><span class="o">=</span>&lt;GID&gt;
s3fs &lt;space_name&gt; /var/www/stream-thumb -o <span class="nv">url</span><span class="o">=</span>&lt;s3 endpoint&gt; -o <span class="nv">use_cache</span><span class="o">=</span>/tmp -o allow_other -o use_path_request_style -o <span class="nv">uid</span><span class="o">=</span>&lt;UID&gt; -o <span class="nv">gid</span><span class="o">=</span>&lt;GID&gt;
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Verify the Mount was successful. The buckets should show as a s3fs mount at the bottom of the output</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mount
</pre></div>
</div>
<blockquote>
<div><p>Note: To mount persistently, you can add the following to your fstab file</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s3fs</span><span class="c1">#&lt;bucket_name&gt; /var/www/images fuse url=&lt;endpoint_url&gt;,use_cache=/tmp,allow_other,use_path_request_style,_netdev,uid=33,gid=33 0 0</span>
</pre></div>
</div>
</section>
<section id="ejabberd">
<h4>Ejabberd<a class="headerlink" href="#ejabberd" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 6 - “Install Ejabberd”</p></li>
<li><p>During the install process, the Config Tool will ask for an Ejabberd Full Qualified Domain Name (FQDN). This should be the same as the public domain name which will be used to access OSP. This should be a valid DNS entry. Use of an IP address may not function properly.</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>Setup a new Ejabberd admin account.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo /usr/local/ejabberd/bin/ejabberdctl register admin localhost &lt;password&gt;
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Edit the ejabberd.yml</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /usr/local/ejabberd/conf/ejabberd.yml
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Change the following lines to match your expected configuration:</p></li>
</ol>
<ul class="simple">
<li><p>Line 43-44</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5443</span><span class="w"></span>
<span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Line 55-56</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5280</span><span class="w"></span>
<span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Line 77-78</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4560</span><span class="w"></span>
<span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;::&quot;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Line 91-93 (Add one line per OSP core or use CIDR Notation to allow a block of IPs)</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ip</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.0/8</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">::1/128</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;ip address of OSP Core&gt;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>Save the ejabberd.yml file</p></li>
<li><p>Edit the auth_osp.py Authentication Handler</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">auth_osp</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li><p>Edit the protocol and ospAPIServer variables to match your OSP Core Instance.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;https&quot;</span>
<span class="n">ospAPIServer</span> <span class="o">=</span> <span class="s2">&quot;osp.example.com&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="14">
<li><p>Save the auth_osp.py file</p></li>
<li><p>Restart Ejabberd</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart ejabberd
</pre></div>
</div>
</section>
<section id="redis">
<h4>Redis<a class="headerlink" href="#redis" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Install Redis</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt update
sudo apt install redis-server
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Edit the redis.conf file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /etc/redis/redis.conf
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Find &amp; Edit the bind location to listen on all interfaces</p></li>
</ol>
<div class="highlight-conf notranslate"><div class="highlight"><pre><span></span>bind 0.0.0.0
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Find and Set a Redis Password</p></li>
</ol>
<div class="highlight-conf notranslate"><div class="highlight"><pre><span></span>requirepass &lt;Password&gt;
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Save the redis.conf file</p></li>
<li><p>Restart Redis</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart redis.service
</pre></div>
</div>
</section>
<section id="database">
<h4>Database<a class="headerlink" href="#database" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Install MariaDB</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get update <span class="o">&amp;&amp;</span> sudo apt-get install mariadb-server
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Download the OSP Modifications for MariaDB</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo wget <span class="s2">&quot;https://gitlab.com/Deamos/flask-nginx-rtmp-manager/-/raw/master/setup/mysql/mysqld.cnf&quot;</span> -O /etc/mysql/my.cnf
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Edit the my.cnf file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /etc/mysql/my.cnf
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Edit the bind-bind address to listen on all interfaces</p></li>
</ol>
<div class="highlight-cnf notranslate"><div class="highlight"><pre><span></span>bind-address = 0.0.0.0
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Restart MariaDB</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart mysql
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Log into MariaDB</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mysql
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Create the Database &amp; User. Be aware the remote server ips should be the IP address(es) of the OSP-Core Systems (See https://mariadb.com/kb/en/configuring-mariadb-for-remote-client-access/#granting-user-connections-from-remote-hosts)</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">osp</span><span class="p">;</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;&lt;username&gt;&#39;</span><span class="o">@</span><span class="s1">&#39;&lt;remote_server_ip&gt;&#39;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;&lt;password&gt;&#39;</span><span class="p">;</span><span class="w"></span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">osp</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;&lt;username&gt;&#39;</span><span class="o">@</span><span class="s1">&#39;&lt;remote_server_ip&gt;&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Quit the MariaDB Console</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>The Database will be initialized on the successful run of an OSP-Core Instance</p></li>
</ol>
</section>
<section id="osp-core">
<h4>OSP-Core<a class="headerlink" href="#osp-core" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 2 - “Install OSP-Core”</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>Copy the OSP config.py.dist file to config.py</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cp /opt/osp/conf/config.py.dist /opt/osp/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Edit the config.py file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /opt/osp/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Change the dbLocation variable to match your database credentials and IP/DNS</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dbLocation</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://&lt;user&gt;:&lt;password&gt;@&lt;db_host&gt;/&lt;db_name&gt;?charset=utf8mb4&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Change the Redis variables to match the IP/DNS and password set for it</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">redisHost</span><span class="o">=</span><span class="s2">&quot;redis.example.com&quot;</span>
<span class="n">redisPort</span><span class="o">=</span><span class="mi">6379</span>
<span class="n">redisPassword</span><span class="o">=</span><span class="s2">&quot;redis_password&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>Change the Ejabberd variables to match your configuration</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ejabberdAdmin</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span> <span class="o">&lt;--</span><span class="n">Leave</span> <span class="n">this</span> <span class="k">as</span> <span class="n">admin</span>
<span class="n">ejabberdPass</span> <span class="o">=</span> <span class="s2">&quot;ejabberd_admin_password&quot;</span>
<span class="n">ejabberdHost</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span> <span class="o">&lt;--</span><span class="n">Leave</span> <span class="n">this</span> <span class="k">as</span> <span class="n">localhost</span>
<span class="n">ejabberdServer</span> <span class="o">=</span><span class="s2">&quot;ejabberd.example.com&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="12">
<li><p>Review the values in the OSP /opt/osp/conf/config.py.</p></li>
</ol>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> secretKey and passwordSalt should be changed from their default values.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /opt/osp/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li><p>Restart the OSP Core Workers</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart osp.target
</pre></div>
</div>
<ol class="arabic simple" start="14">
<li><p>Save the config.py file</p></li>
<li><p>Initialize the Database by running the command line upgrader</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo bash osp-config.sh upgrade db
</pre></div>
</div>
<ol class="arabic simple" start="16">
<li><p>Open a web browser and browse to:
<code class="docutils literal notranslate"><span class="pre">http://&lt;OSPCore</span> <span class="pre">IP</span> <span class="pre">Address</span> <span class="pre">or</span> <span class="pre">DNS&gt;</span></code></p></li>
<li><p>Setup OSP using the Initial Configuration Wizard</p></li>
</ol>
</section>
<section id="osp-rtmp">
<h4>OSP-RTMP<a class="headerlink" href="#osp-rtmp" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 3 - “Install OSP-RTMP”</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>Copy and Edit the OSP-RTMP config.py file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cp /opt/osp-rtmp/conf/config.py.dist /opt/osp-rtmp/conf/config.py
sudo nano /opt/osp-rtmp/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Change the ospCoreAPI Variable to point at your OSP-Core instance</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ospCoreAPI</span> <span class="o">=</span> <span class="s2">&quot;http://ospcore.example.com&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Start the OSP-RTMP Instance</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl start osp-rtmp
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Open a web browser and go to your OSP-Core Instance</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ospcore</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>Log on as an Admin and Open the Admin Settings</p></li>
<li><p>Select RTMP Servers</p></li>
<li><p>Click the Plus Sign Button</p></li>
<li><p>Type in the IP or Fully Qualified Domain Name for your OSP-RTMP Server and click Add</p></li>
</ol>
</section>
<section id="osp-edge">
<h4>OSP-Edge<a class="headerlink" href="#osp-edge" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 4 - “Install OSP-Edge”</p></li>
<li><p>When prompted, input the IP address of your OSP-RTMP Instance</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>If you need to add additional authorized OSP-RTMP Instances, edit the osp-edge-rtmp.conf file for Nginx</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /usr/local/nginx/conf/services/osp-edge-rtmp.conf
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Add any additional authorize publishing IPs to stream-data and stream-data-adapt:</p></li>
</ol>
<div class="highlight-conf notranslate"><div class="highlight"><pre><span></span>allow publish &lt;IP Address&gt;;
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Restart Nginx</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart nginx-osp
</pre></div>
</div>
<ol class="arabic simple" start="12">
<li><p>Open a web browser and go to your OSP-Core Instance</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ospcore</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li><p>Log on as an Admin and Open the Admin Settings</p></li>
<li><p>Select Edge Streamers</p></li>
<li><p>Add the Fully Qualified Domain Name or IP Address of the Edge Server</p></li>
<li><p>Add the Load Percentage that the Edge Server will use.</p></li>
</ol>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> The sum of all Edge Servers must equal 100%.</p>
</div></blockquote>
<ol class="arabic simple" start="17">
<li><p>Restart Nginx on all OSP-Core Servers</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart nginx-osp
</pre></div>
</div>
</section>
<section id="osp-proxy">
<h4>OSP-Proxy<a class="headerlink" href="#osp-proxy" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Clone the git repository</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitlab.com/Deamos/flask-nginx-rtmp-manager.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Install the Config Tool Prerequisites (if not already installed)</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install dialog
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run the OSP Configuration Tool</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> flask-nginx-rtmp-manager
sudo bash osp-config.sh
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Select Option 1 - “Install…”</p></li>
<li><p>Select Option 5 - “Install OSP-Proxy”</p></li>
<li><p>When prompted, input the Protocol and Fully Qualified Domain Name of your OSP-Core Instance (ex: https://osp.example.com)</p></li>
<li><p>On completion, exit the OSP Config Tool.</p></li>
<li><p>If you are using TLS/SSL on your Core Site, Acquire a TLS Certificate</p></li>
<li><p>Edit /usr/local/nginx/conf/custom/osp-proxy-custom-servers.conf</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /usr/local/nginx/conf/custom/osp-proxy-custom-servers.conf
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Change Line 8 to match your OSP Core FQDN</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valid_referers</span> <span class="n">server_names</span> <span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">~.</span><span class="p">;</span>
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>If you are using TLS, Comment the following Line:
<code class="docutils literal notranslate"><span class="pre">listen</span> <span class="pre">80</span> <span class="pre">default_server;</span></code></p></li>
<li><p>Uncomment the following lines and add the TLS configuration:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># listen 443 ssl http2 default_server;</span>
<span class="c1"># ssl_certificate /etc/letsencrypt/live/osp.example.com/fullchain.pem;</span>
<span class="c1"># ssl_certificate_key /etc/letsencrypt/live/osp.example.com/privkey.pem;</span>
<span class="c1"># ssl_protocols TLSv1.2 TLSv1.3;</span>
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li><p>Edit the OSP-Proxy Configuration File</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /opt/osp-proxy/conf/config.py
</pre></div>
</div>
<ol class="arabic simple" start="14">
<li><p>Change the Flask Secret Key to a Random Value</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flask Secret Key</span>
<span class="n">secretKey</span><span class="o">=</span><span class="s2">&quot;CHANGEME&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="15">
<li><p>If you are dedicating the proxy to a specific source (An Edge or Another Proxy), uncomment the ForceDestination Lines and set to match your source</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Force Destination - Use to point to Specified Edge Server or Tiered Proxy. Uncomment to override API&#39;s RTMP List and use the destination you list</span>
<span class="n">forceDestination</span> <span class="o">=</span> <span class="s2">&quot;edge.example.com&quot;</span>
<span class="n">forceDestinationType</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span> <span class="c1"># Choices are &quot;edge&quot;, &quot;proxy&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="15">
<li><p>Restart Nginx-OSP and OSP-Proxy</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart nginx-osp
sudo systemctl restart osp-proxy
</pre></div>
</div>
<ol class="arabic simple" start="16">
<li><p>Ensure all Edge or RTMP Servers are listed in the OSP-Core Admin Panel. OSP-Proxy will query the OSP API and generate configurations to handle the proxy connection to retrieve the HLS fragments.</p></li>
<li><p>Perform a first run of the Configuration File Generator</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /opt/osp
sudo bash updateUpstream.sh
</pre></div>
</div>
<ol class="arabic simple" start="18">
<li><p>Connect to each OSP-RTMP/Single Server and perform the following on each:</p></li>
</ol>
<ul class="simple">
<li><p>If using TLS on the Core, Generate a TLS certificate</p></li>
<li><p>Edit the /usr/local/nginx/conf/custom/osp-rtmp-custom-authorizeproxy.conf</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /usr/local/nginx/conf/custom/osp-rtmp-custom-authorizeproxy.conf
</pre></div>
</div>
<ul class="simple">
<li><p>Add the IP Address of each OSP-Proxy that will be accessing the source for /stream-thumb, /live-adapt, and /live:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># allow &lt;ip of proxy&gt;;</span>
<span class="n">allow</span> <span class="mf">201.13.12.50</span><span class="p">;</span>
<span class="n">allow</span> <span class="mf">193.10.3.9</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If using TLS, Edit the /usr/local/nginx/conf/custom/osp-rtmp-custom-server</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span><span class="n">osp</span><span class="o">-</span><span class="n">rtmp</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Comment out the first line, uncomment the TLS information and add your certificate info (Note: Port 5999 will stay the same):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#listen 5999 default_server;</span>
<span class="c1">### Comment Above and Uncomment/Edit Below for OSP-Proxy TLS ###</span>
<span class="n">listen</span> <span class="mi">5999</span> <span class="n">ssl</span> <span class="n">http2</span> <span class="n">default_server</span><span class="p">;</span>
<span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="n">ssl_protocols</span> <span class="n">TLSv1</span><span class="mf">.2</span> <span class="n">TLSv1</span><span class="mf">.3</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Restart the Nginx-OSP instance</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart nginx-osp
</pre></div>
</div>
<ol class="arabic simple" start="18">
<li><p>If you forced an Edge Server on Step 14, Connect to the Edge Server and edit /usr/local/nginx/conf/locations/osp-edge-redirects.conf</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /usr/local/nginx/conf/custom/osp-edge-redirects.conf
</pre></div>
</div>
<ul class="simple">
<li><p>Comment the add_headers line for /edge and /edge-adapt</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#add_header &#39;Access-Control-Allow-Origin&#39; &quot;*&quot; always;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Edit the custom referes file at /usr/local/nginx/conf/custom/osp-edge-custom-refer.conf</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span><span class="n">osp</span><span class="o">-</span><span class="n">edge</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">refer</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Add the OSP Core Server to the Valid Referers list for /edge and /edge-adapt</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valid_referers</span> <span class="n">server_names</span> <span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">~.</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Restart Nginx-OSP</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">nginx</span><span class="o">-</span><span class="n">osp</span>
</pre></div>
</div>
<ol class="arabic simple" start="19">
<li><p>Add the OSP-Proxy Domain to the OSP-Core’s Admin Panel under Settings</p></li>
<li><p>Test a Stream and verify that the video is displaying</p></li>
</ol>
</section>
</section>
<section id="manual-install">
<h3>Manual Install<a class="headerlink" href="#manual-install" title="Permalink to this headline"></a></h3>
<p>Coming Soon</p>
</section>
<section id="docker-install">
<h3>Docker Install<a class="headerlink" href="#docker-install" title="Permalink to this headline"></a></h3>
<blockquote>
<div><p>IMPORTANT NOTE: OSP’s Docker install is currently on the Beta 6d release due to the need to rework the Dockerfile for eJabberd for chat.
{.is-warning}</p>
</div></blockquote>
<p>A Dockerfile has been provided for running OSP in a container. However due to the way NginX, Gunicorn, Flask, and Docker work, for OSP to work properly, the Frontend must be exposed using Port 80 or 443 and the RTSP port from OBS or other streaming software must be exposed on Port 1935.
This accomplished easily by using a reverse proxy in Docker such as Traefik. However, Port 1935 will not be proxied and must be mapped to the same port on the host.
An external Redis server/container is required to handling asynchronous communications between the internal Gunicorn worker instances.
Dockerhub URL: https://hub.docker.com/r/deamos/openstreamingplatform</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">pull</span> <span class="n">deamos</span><span class="o">/</span><span class="n">openstreamingplatform</span>
</pre></div>
</div>
<section id="environment-variables">
<h4>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline"></a></h4>
<p>DB_URL: Sets the SQLAlchemy URL String for the used DB.
Default: “sqlite:///db/database.db”
See https://docs.sqlalchemy.org/en/13/core/engines.html
FLASK_SECRET: Flask Secret Key
Format: “CHANGEME”
FLASK_SALT: Flask User Salt Value
Format: “CHANGEME”
OSP_ALLOWREGISTRATION: Sets OSP to allow users to create accounts
Default: True
OSP_REQUIREVERIFICATION: Sets New OSP user accounts to verify their email addresses
Default: True
REDIS_HOST: Sets the Redis Instance IP/Hostname (REQUIRED)
REDIS_PORT: Sets the Redis Instance Port
Default: 6379
REDIS_PASSWORD: Sets the Redis Instance Password, if needed</p>
</section>
<section id="added-in-beta-5a">
<h4>Added in Beta 5a<a class="headerlink" href="#added-in-beta-5a" title="Permalink to this headline"></a></h4>
<p>Beta 5a will add additional Environment Variable to pre-configure OSP without needing to run the “First Run” Configuration</p>
<ul class="simple">
<li><p>OSP_ADMIN_USER</p></li>
<li><p>OSP_ADMIN_EMAIL</p></li>
<li><p>OSP_ADMIN_PASSWORD</p></li>
<li><p>OSP_SERVER_NAME</p></li>
<li><p>OSP_SERVER_PROTOCOL</p></li>
<li><p>OSP_SERVER_ADDRESS</p></li>
<li><p>OSP_SMTP_SEND_AS</p></li>
<li><p>OSP_SMTP_SERVER</p></li>
<li><p>OSP_SMTP_PORT</p></li>
<li><p>OSP_SMTP_USER</p></li>
<li><p>OSP_SMTP_PASSWORD</p></li>
<li><p>OSP_SMTP_TLS</p></li>
<li><p>OSP_SMTP_SSL</p></li>
<li><p>OSP_ALLOW_RECORDING</p></li>
<li><p>OSP_ALLOW_UPLOAD</p></li>
<li><p>OSP_ADAPTIVE_STREAMING</p></li>
<li><p>OSP_ALLOW_COMMENT</p></li>
<li><p>OSP_DISPLAY_EMPTY</p></li>
</ul>
</section>
<section id="recommended-volumes-mount-points">
<h4>Recommended Volumes/Mount Points<a class="headerlink" href="#recommended-volumes-mount-points" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>/var/www - Storage of Images, Streams, and Stored Video Files</p></li>
<li><p>/opt/osp/db/ - SQLite DB Location (if used)</p></li>
<li><p>/usr/local/nginx/conf - Contains the NginX Configuration files which can be altered to suit your needs (HTTPS without something like Traefik)</p></li>
</ul>
</section>
</section>
</section>
<section id="database-setup">
<h2>Database Setup<a class="headerlink" href="#database-setup" title="Permalink to this headline"></a></h2>
<section id="id1">
<h3>Installation<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<section id="set-up-mysql">
<h4>Set Up MySQL<a class="headerlink" href="#set-up-mysql" title="Permalink to this headline"></a></h4>
<p>Prior to using MySQL with OSP the first time, do the following to configure OSP for full Unicode Support (UTF8MB4)</p>
<ol class="arabic simple">
<li><p>Install MySQL Server on Database Server or OSP Server</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install mysql-server
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Copy the MySQL Configuration File in to MySQL</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cp /opt/osp/setup/mysql/mysqld.cnf /etc/mysql/my.cnf
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Restart MySQL</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart mysql
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Open MySQL and create the OSP Database and User</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span>
</pre></div>
</div>
<div class="highlight-mysql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">osp</span><span class="p">;</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;newuser&#39;</span><span class="nv">@&#39;localhost&#39;</span><span class="w"> </span><span class="k">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">;</span><span class="w"></span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">osp</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;newuser&#39;</span><span class="nv">@&#39;localhost&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Edit the OSP Configuration File to use MySQL</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">osp</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>From:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbLocation</span><span class="o">=</span><span class="s2">&quot;sqlite:///db/database.db&quot;</span>
</pre></div>
</div>
<p>To:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbLocation</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://username:password@localhost/osp?charset=utf8mb4&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Restart OSP</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">osp</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: For Servers that have upgraded from versions prior to Beta 6, see https://wiki.openstreamingplatform.com/Install/Tweaks#database to convert from UTF8 to UTF8MB4 for Full Unicode Support</p>
</div></blockquote>
</section>
</section>
<section id="backup-and-restore">
<h3>Backup and Restore<a class="headerlink" href="#backup-and-restore" title="Permalink to this headline"></a></h3>
<section id="backup">
<h4>Backup<a class="headerlink" href="#backup" title="Permalink to this headline"></a></h4>
<ol class="arabic simple">
<li><p>Go to the Admin Settings Page</p></li>
<li><p>Select Backup/Restore and Click Download</p></li>
</ol>
</section>
<section id="restore">
<h4>Restore<a class="headerlink" href="#restore" title="Permalink to this headline"></a></h4>
<blockquote>
<div><p>Warning: If you have MySQL setup for Caching, it is recommended to temporarily disable it prior to restoring a backup. Failure to do so may cause the restore to fail.</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Go to Backup/Restore in the Admin Settings page or Select Restore from Backup on the Initial Setup Wizard</p></li>
<li><p>Click Browse and Select the OSP Backup JSON File</p></li>
<li><p>Check Restore Recorded Video DB Table, if you would like to retain Video and Clip Information.</p></li>
<li><p>Click Restore</p></li>
</ol>
</section>
</section>
<section id="migration">
<h3>Migration<a class="headerlink" href="#migration" title="Permalink to this headline"></a></h3>
<section id="moving-from-utf8-to-utf8mb4-in-mysql">
<h4>Moving from UTF8 to UTF8MB4 in MySQL<a class="headerlink" href="#moving-from-utf8-to-utf8mb4-in-mysql" title="Permalink to this headline"></a></h4>
<p>Installs prior to Beta 6 were not configured to fully use UTF8MB4 and may not be able to use the full Unicode set. To correct this issue, do the following:</p>
<ol class="arabic simple">
<li><p>Backup your existing Database per the proceedures above.</p></li>
<li><p>Shut down OSP</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">osp</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Open the MySQL Console</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Drop the OSP Database;</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drop</span> <span class="n">database</span> <span class="n">osp</span><span class="p">;</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Exit the MySQL Console</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quit</span><span class="p">;</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Follow the steps for Setting up a New MySQL install, starting at Step 2</p></li>
<li><p>On the Insital Setup Wizard, Restore your Database Per the Steps under Restore Above.</p></li>
</ol>
</section>
</section>
</section>
<section id="chat-xmpp">
<h2>Chat (XMPP)<a class="headerlink" href="#chat-xmpp" title="Permalink to this headline"></a></h2>
<p>Beginning with OSP v0.7.0, Chat has been moved to an XMPP based system using ejabberd. Channel chatrooms now maintain a temporary history and can be accessed by Guests, if configured.</p>
<section id="id2">
<h3>Installation<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h3>
<section id="single-server">
<h4>Single Server<a class="headerlink" href="#single-server" title="Permalink to this headline"></a></h4>
<p>By default, OSP will automatically install and configure XMPP components for use during install or upgrade to versions 0.7.0 or above. During the upgrade process, you will be prompted to enter the OSP Site Address. This address must match the OSP Site Address (Typically the OSP Fully Qualified Domain Name (FQDN) or IP Address of OSP) Failure to enter the correct address will cause the Chat system to not function properly.
If you must change your OSP Site Address, this change must also be made to the ejabberd.yml configuration file and ejabberd restarted.
You can find the ejabberd.yml file in <code class="docutils literal notranslate"><span class="pre">/usr/local/ejabberd/conf/ejabberd.yml</span></code> and edit the following lines:
<em>Line 17-19</em></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">hosts</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CHANGEME &lt;---Your OSP Site Address</span><span class="w"></span>
</pre></div>
</div>
<p><em>Line 167-173</em></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host_config</span><span class="p">:</span><span class="w"></span>
<span class="s">&quot;CHANGEME&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;---Your OSP Site Address</span><span class="w"></span>
<span class="nt">auth_method</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">anonymous</span><span class="w"></span>
<span class="nt">allow_multiple_connections</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">anonymous_protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">login_anon</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart ejabberd
</pre></div>
</div>
<p>OSP will also automatically set the ownership for each created OSP Channel and set the Channel Owner to Admin/Owner for the XMPP channel on start of the OSP service. If you have an issue with ownership, it is recommended to restart OSP to perform an XMPP Rebuild.</p>
</section>
<section id="external-server">
<h4>External Server<a class="headerlink" href="#external-server" title="Permalink to this headline"></a></h4>
<blockquote>
<div><p>Supported on versions &gt;= 0.7.9
{.is-info}
Ejabberd can be configured to run an an external service. However, some manual changes must be made to allow it to operate with OSP properly.
To setup an external ejabberd server, do the following:</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Install ejabberd on a separate server</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo wget -O <span class="s2">&quot;/tmp/ejabberd-20.04-linux-x64.run&quot;</span> <span class="s2">&quot;https://www.process-one.net/downloads/downloads-action.php?file=/20.04/ejabberd-20.04-linux-x64.run&quot;</span>
chmod +x /tmp/ejabberd-20.04-linux-x64.run
/tmp/ejabberd-20.04-linux-x64.run ----unattendedmodeui none --mode unattended --prefix /usr/local/ejabberd --cluster <span class="m">0</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Create the conf directory and copy the ejabberd configuration yml, inetrc, and auth_osp.py from the OSP Repo to the directory</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mkdir /usr/local/ejabberd/conf
wget -O <span class="s2">&quot;/usr/local/ejabberd/conf/ejabberd.yml&quot;</span> <span class="s2">&quot;https://gitlab.com/osp-group/flask-nginx-rtmp-manager/-/raw/master/installs/ejabberd/setup/ejabberd.yml&quot;</span>
wget -O <span class="s2">&quot;/usr/local/ejabberd/conf/inetrc&quot;</span> <span class="s2">&quot;https://gitlab.com/osp-group/flask-nginx-rtmp-manager/-/raw/master/installs/ejabberd/setup/inetrc&quot;</span>
wget -O <span class="s2">&quot;/usr/local/ejabberd/conf/auth_osp.py&quot;</span> <span class="s2">&quot;https://gitlab.com/osp-group/flask-nginx-rtmp-manager/-/raw/master/installs/ejabberd/setup/auth_osp.py&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Edit the /usr/local/ejabberd/conf/ejabberd.yml file and update the fields based on your configuration
<strong>Line 17-19</strong>: Set CHANGEME to your OSP’s FQDN</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hosts</span><span class="p">:</span>
<span class="o">-</span> <span class="n">localhost</span>
<span class="o">-</span> <span class="n">OSP</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p><strong>Line 43-53</strong>: Change ip to “::”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">:</span> <span class="mi">5443</span>
<span class="n">ip</span><span class="p">:</span> <span class="s2">&quot;::&quot;</span>
<span class="n">module</span><span class="p">:</span> <span class="n">ejabberd_http</span>
<span class="n">tls</span><span class="p">:</span> <span class="n">true</span>
<span class="n">request_handlers</span><span class="p">:</span>
<span class="o">/</span><span class="n">admin</span><span class="p">:</span> <span class="n">ejabberd_web_admin</span>
<span class="o">/</span><span class="n">api</span><span class="p">:</span> <span class="n">mod_http_api</span>
<span class="o">/</span><span class="n">bosh</span><span class="p">:</span> <span class="n">mod_bosh</span>
<span class="o">/</span><span class="n">captcha</span><span class="p">:</span> <span class="n">ejabberd_captcha</span>
<span class="o">/</span><span class="n">upload</span><span class="p">:</span> <span class="n">mod_http_upload</span>
<span class="o">/</span><span class="n">ws</span><span class="p">:</span> <span class="n">ejabberd_http_ws</span>
</pre></div>
</div>
<p><strong>Line 55-65</strong>: Change ip to “::”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">:</span> <span class="mi">5280</span>
<span class="n">ip</span><span class="p">:</span> <span class="s2">&quot;::&quot;</span>
<span class="n">module</span><span class="p">:</span> <span class="n">ejabberd_http</span>
<span class="n">request_handlers</span><span class="p">:</span>
<span class="o">/</span><span class="n">admin</span><span class="p">:</span> <span class="n">ejabberd_web_admin</span>
<span class="o">/</span><span class="n">api</span><span class="p">:</span> <span class="n">mod_http_api</span>
<span class="o">/</span><span class="n">bosh</span><span class="p">:</span> <span class="n">mod_bosh</span>
<span class="o">/</span><span class="n">captcha</span><span class="p">:</span> <span class="n">ejabberd_captcha</span>
<span class="o">/</span><span class="n">upload</span><span class="p">:</span> <span class="n">mod_http_upload</span>
<span class="o">/</span><span class="n">ws</span><span class="p">:</span> <span class="n">ejabberd_http_ws</span>
<span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span><span class="p">:</span> <span class="n">ejabberd_acme</span>
</pre></div>
</div>
<p><strong>Line 77-83</strong>: Change ip to “::”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">:</span> <span class="mi">4560</span>
<span class="n">ip</span><span class="p">:</span> <span class="s2">&quot;::&quot;</span>
<span class="n">module</span><span class="p">:</span> <span class="n">ejabberd_xmlrpc</span>
<span class="n">access_commands</span><span class="p">:</span>
<span class="n">admin</span><span class="p">:</span>
<span class="n">commands</span><span class="p">:</span> <span class="nb">all</span>
<span class="n">options</span><span class="p">:</span> <span class="p">[]</span>
</pre></div>
</div>
<p><strong>Line 87-96</strong>: Add the IP Address to your OSP Instances in the ip block</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">acl</span><span class="p">:</span>
<span class="n">local</span><span class="p">:</span>
<span class="n">user_regexp</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">loopback</span><span class="p">:</span>
<span class="n">ip</span><span class="p">:</span>
<span class="o">-</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span>
<span class="o">-</span> <span class="p">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
<span class="o">-</span> <span class="n">YOUR</span> <span class="n">OSP</span> <span class="n">IP</span> <span class="n">HERE</span>
<span class="n">admin</span><span class="p">:</span>
<span class="n">user</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;admin@localhost&quot;</span>
</pre></div>
</div>
<p><strong>Line 164</strong>: Change the location of the auth_osp.py file to match below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extauth_program</span><span class="p">:</span> <span class="s2">&quot;/usr/bin/python3 /usr/local/ejabberd/conf/auth_osp.py&quot;</span>
</pre></div>
</div>
<p><strong>Line 167-173</strong>: Set CHANGEME to your OSP’s FQDN</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host_config</span><span class="p">:</span>
<span class="s2">&quot;OSP.example.com&quot;</span><span class="p">:</span>
<span class="n">auth_method</span><span class="p">:</span>
<span class="o">-</span> <span class="n">external</span>
<span class="o">-</span> <span class="n">anonymous</span>
<span class="n">allow_multiple_connections</span><span class="p">:</span> <span class="n">true</span>
<span class="n">anonymous_protocol</span><span class="p">:</span> <span class="n">login_anon</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Install Python Requirements</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install python3-pip
sudo pip3 install requests
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Edit the /usr/local/ejabberd/conf/auth_osp.py file
<strong>Line 4-5</strong>: Change the protocol and ospAPIServer values to match your OSP Instance</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
<span class="n">ospAPIServer</span> <span class="o">=</span> <span class="s2">&quot;OSP.example.com&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Copy the ejabberd SystemD file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cp /usr/local/ejabberd/bin/ejabberd.service /etc/systemd/system/ejabberd.service
sudo systemctl daemon-reload
sudo systemctl <span class="nb">enable</span> ejabberd
sudo systemctl start ejabberd
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Configure the local admin account with a password. Do not change the localadmin part</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo /usr/local/ejabberd/bin/ejabberdctl register admin localhost YOURADMINPASSWORD
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Install Nginx to reverse proxy the XMPP Bosh Port</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Edit the default Nginx site file for the reverse proxy and add the following in the server directive block</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">default</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>location /http-bind/ { # BOSH XMPP-HTTP
proxy_pass http://localhost:5280/bosh;
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $remote_addr;
proxy_redirect off;
proxy_buffering off;
proxy_read_timeout 65s;
proxy_send_timeout 65s;
keepalive_timeout 65s;
tcp_nodelay on;
}
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Restart the Nginx Service</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart nginx
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>On the OSP Server, update the ejabberd admin password and add the ejabberdServer variable to the /opt/osp/conf/config.py file</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo vi /opt/osp/conf/config.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># EJabberD Configuration</span>
<span class="n">ejabberdAdmin</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
<span class="n">ejabberdPass</span> <span class="o">=</span> <span class="s2">&quot;YOURADMINPASSWORD&quot;</span>
<span class="n">ejabberdHost</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="n">ejabberdServer</span> <span class="o">=</span> <span class="s2">&quot;ejabberd.example.com&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="12">
<li><p>Restart the OSP Server</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl restart osp.target
</pre></div>
</div>
</section>
</section>
<section id="network-configuration">
<h3>Network Configuration<a class="headerlink" href="#network-configuration" title="Permalink to this headline"></a></h3>
<p>OSP’s XMPP configuration requires the following open ports for chat to function:</p>
<ul class="simple">
<li><p>TCP/5222: Used for ejabberd Client to Server connections</p></li>
<li><p>TCP/5269: Used for ejabberd Server to Server connections</p></li>
<li><p>TCP/5443: External Server Jabber HTTPS-BOSH connection <em>External Server Only</em></p></li>
<li><p>TCP/5280: External Server Jabber HTTP-BOSH connection <em>External Server Only</em></p></li>
<li><p>TCP/4560: External Server XML-RPC Server Control <em>External Server Only</em></p></li>
</ul>
</section>
<section id="osp-configuration">
<h3>OSP Configuration<a class="headerlink" href="#osp-configuration" title="Permalink to this headline"></a></h3>
<p>XMPP Channels are configured on a channel by channel basis. You can find the settings under Your Channels -&gt; Chat
<img alt="2020-06-07_19_53_27-osp_demo_-user_channels_page_and_11_more_pages-personal-_microsoft​_edge.png" src="2020-06-07_19_53_27-osp_demo_-_user_channels_page_and_11_more_pages_-_personal_-_microsoft%E2%80%8B_edge.png" />
Channel configuration allows you to define who is allowed to chat, how chat is managed, and who can manage it.</p>
<ul class="simple">
<li><p><strong>Room Title:</strong> Name of Room, displayed to XMPP Chat Clients</p></li>
<li><p><strong>Description:</strong> Room description, displayed to XMPP Chat Clients</p></li>
<li><p><strong>Moderated:</strong> Only Users Identified as Participants may Chat</p></li>
<li><p><strong>Allow guests to join room:</strong> Allow Unauthenticated Guest Users to Join the Chat</p></li>
<li><p><strong>Allow guests to chat:</strong> Automatically set Unauthenticated Guest Users as Participants
You may also define automatic moderators for your channel in the Add Moderator section.</p></li>
</ul>
</section>
<section id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h3>
<p>The Chat Window is a basic display of conversations and moderation controls for users and admins. You can view who is in a channel, view their profile, or control basic functions such as ban lists or channel roles.
<img alt="2020-06-07_20_04_07-osp_demo_-osp_demo_1_and_11_more_pages-personal-_microsoft​_edge.png" src="2020-06-07_20_04_07-osp_demo_-_osp_demo_1_and_11_more_pages_-_personal_-_microsoft%E2%80%8B_edge.png" />
All users are set as one the following roles:</p>
<ul class="simple">
<li><p><strong>Moderator</strong>: Able to control the room and has access to all moderator controls</p></li>
<li><p><strong>Participant</strong>: Able to Chat in the room (ie: has voice)</p></li>
<li><p><strong>Guest</strong>: Able to view Chat in the room, but can not chat.
Any role changes made by a moderator are set as permanent and will remain on joining / leaving a room.</p></li>
</ul>
</section>
<section id="user-options">
<h3>User Options<a class="headerlink" href="#user-options" title="Permalink to this headline"></a></h3>
<p>By clicking on a username in chat or in the User List, users and moderators are displayed options targeting that user.
<img alt="2020-06-07_20_10_21-osp_demo_-osp_demo_1_and_11_more_pages-personal-_microsoft​_edge.png" src="2020-06-07_20_10_21-osp_demo_-_osp_demo_1_and_11_more_pages_-_personal_-_microsoft%E2%80%8B_edge.png" /></p>
</section>
<section id="user-controls">
<h3>User Controls<a class="headerlink" href="#user-controls" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>Profile</strong>: Opens a Popup that displays the User’s Bio and any Channels, Streams, Videos, or Clips they may own</p></li>
<li><p><strong>Mute</strong>: Hides all chat from a user for your account. You will no longer see any messages from the user until you unmute them.</p></li>
</ul>
</section>
<section id="mod-controls">
<h3>Mod Controls<a class="headerlink" href="#mod-controls" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>Kick</strong>: Removes the user from the chatroom.</p></li>
<li><p><strong>Ban</strong>: Removes the user from the chatroom and flags their username as banned.</p></li>
<li><p><strong>Change Role / Set as Moderator</strong>: Sets the User to have Moderator Controls</p></li>
<li><p><strong>Change Role / Set as Participant</strong>: Sets the User to be a Participant (Able to Chat if Channel is set to Moderated)</p></li>
<li><p><strong>Change Role / Set as Guest</strong>: Sets the User to be a Guest (Can’t Chat if Channel is set to Moderated)</p></li>
<li><p><strong>Channel Voice Controls / Voice</strong>: Temporarily grants Participant Status</p></li>
<li><p><strong>Channel Voice Controls / Devoice</strong>: Temporarily removes Participant Status</p></li>
</ul>
</section>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline"></a></h3>
<p>Each User maintains an XMPP token which is required to authenticate to the Chat Server. This is handled by OSP by default, but the token can also be used to authenticate using an XMPP client. To find you XMPP token, you can go to your user settings and copy the XMPP token at the bottom of the page.
<img alt="2020-06-07_20_23_32-osp_test_3_-user_settings_and_12_more_pages-personal-_microsoft​_edge.png" src="2020-06-07_20_23_32-osp_test_3_-_user_settings_and_12_more_pages_-_personal_-_microsoft%E2%80%8B_edge.png" />
In addition to user XMPP tokens, each channel also maintains a XMPP token to be used when a Channel is set to be protected. In these instances, users may use the Channel XMPP Token to join the Chatroom using an external client.
<img alt="2020-06-07_20_25_05-osp_demo_-user_channels_page_and_12_more_pages-personal-_microsoft​_edge.png" src="2020-06-07_20_25_05-osp_demo_-_user_channels_page_and_12_more_pages_-_personal_-_microsoft%E2%80%8B_edge.png" /></p>
</section>
<section id="two-way-integration-with-other-chat-clients">
<h3>Two Way Integration with Other Chat Clients<a class="headerlink" href="#two-way-integration-with-other-chat-clients" title="Permalink to this headline"></a></h3>
<p>(Provided by djetaine on Discord)</p>
<p>Using Matterbridge, you can integrate your OSP Instance with multiple chat clients like Discord, IRC, Twitch, Telegram, etc.
Each platform should have its own “Bot” relay account that you will need to create.
For additional information and configuration instructions visit the <a class="reference external" href="https://github.com/42wim/matterbridge/wiki/">Matterbridge Wiki</a> directly.</p>
<section id="installation-osp">
<h4>Installation - OSP<a class="headerlink" href="#installation-osp" title="Permalink to this headline"></a></h4>
<p>To facilitate certificate retrieval through the default nginx conf file will need to be modified.
If you cannot connect after you finish the installation, look at the ejabberd logs. In some instances you will need to manually create your cert files which can be done using the instructions under “Troubleshooting”
Create a backup folder and make a copy of your conf file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">~/</span><span class="n">backups</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span> <span class="o">~/</span><span class="n">backups</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Open an editor to modify your conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Add the following to your nginx conf file below the 443 server block</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">##Allow for ejabberd acme-challenge</span>
<span class="n">server</span> <span class="p">{</span>
<span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
<span class="n">server_name</span> <span class="n">conference</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span><span class="p">;</span>
<span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
<span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5280</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="n">server</span> <span class="p">{</span>
<span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
<span class="n">server_name</span> <span class="n">proxy</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span><span class="p">;</span>
<span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
<span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5280</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="n">server</span> <span class="p">{</span>
<span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
<span class="n">server_name</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span><span class="p">;</span>
<span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
<span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5280</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Create DNS Records on your domain registrar for each of the subdomains required by ejabberd.
proxy.subdomain, pubsub.subdomain, conference.subdomain
Perform an nslookup or ping to very name resolution, restart osp and ejabberd then verify connectivity</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">osp</span><span class="o">.</span><span class="n">target</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">ejabberd</span>
<span class="n">cat</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>If the certificate retrieval was successful, you will see success messages for the certificate. Don’t worry about the local host warnings. If you see warnings for your FQDN, verify that your DNS entries are valid.
<img alt="enter image description here" src="https://i.imgur.com/yihxN8W.png" />
Allow ejabberd traffic through your firewall. If you are hosting from home, be sure to port forward to your OSP host.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">5222</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">5269</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">5280</span><span class="o">/</span><span class="n">tcp</span>
</pre></div>
</div>
<p>You can quickly test the external connectivity with an online xmpp client like conversejs
Get your xmpp username and password from your OSP profile settings page at the bottom, then login at <a class="reference external" href="https://conversejs.org/fullscreen.html">https://conversejs.org/fullscreen.html</a>
If you can connect, move forward.</p>
</section>
<section id="install-matterbridge">
<h4>Install Matterbridge<a class="headerlink" href="#install-matterbridge" title="Permalink to this headline"></a></h4>
<p>Matterbridge will run on many different operating systems and container platforms. In this case we will focus on a digital ocean droplet running ubuntu minimal. See the github page for more information on other installations.
Get your instance of ubuntu up and running
Create Matterbridge user, download binaries, set permissions and create the directory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">adduser</span> <span class="o">--</span><span class="n">system</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">home</span> <span class="o">--</span><span class="n">group</span> <span class="n">matterbridge</span>
<span class="n">sudo</span> <span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="mi">42</span><span class="n">wim</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v1</span><span class="mf">.22.3</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">-</span><span class="mf">1.22.3</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="mi">64</span><span class="n">bit</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">matterbridge</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">matterbridge</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">matterbridge</span>
</pre></div>
</div>
<p>You will now create your configuration file. There are a lot of integrations available but this document will focus on Twitch and Discord. More config help can be found in the Matterbridge Wiki
For discord, you will need to create a bot and get it’s auth token. <a class="reference external" href="https://github.com/42wim/matterbridge/wiki/Discord-bot-setup">Create a Discord Bot</a>
Get your ServerID and Channel ID by turning on developer mode then right clicking each to copy the ID.
For twitch, you can create a new “bot” user or user your own. Login to the account you wish to use as a relay, then go to https://twitchapps.com/tmi to get your oauth password. You need the whole thing, including the oauth:
<img alt="enter image description here" src="https://i.imgur.com/2qzKSH2.png" />
Open an editor to create the config</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
<p>You may copy this config file entering your own settings for FQDN, token, server, etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">mydiscord</span><span class="p">]</span>
<span class="n">Token</span><span class="o">=</span><span class="s2">&quot;yourDiscordBotsToken&quot;</span>
<span class="n">Server</span><span class="o">=</span><span class="s2">&quot;YourServerID&quot;</span>
<span class="n">RemoteNickFormat</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{PROTOCOL}</span><span class="s2">-**&lt;</span><span class="si">{NICK}</span><span class="s2">&gt;** &quot;</span>
<span class="p">[</span><span class="n">irc</span><span class="o">.</span><span class="n">twitch</span><span class="p">]</span>
<span class="c1">#Add the oauth token here you got from https://twitchapps.com/tmi/</span>
<span class="n">Password</span><span class="o">=</span><span class="s2">&quot;oauth:SomeLettersAndNumbers&quot;</span>
<span class="n">Nick</span><span class="o">=</span><span class="s2">&quot;YourTwitchBotsName&quot;</span>
<span class="n">Server</span><span class="o">=</span><span class="s2">&quot;irc.twitch.tv:6667&quot;</span>
<span class="n">UseTLS</span><span class="o">=</span><span class="n">false</span>
<span class="n">RemoteNickFormat</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{PROTOCOL}</span><span class="s2">-[</span><span class="si">{NICK}</span><span class="s2">] &quot;</span>
<span class="p">[</span><span class="n">xmpp</span><span class="o">.</span><span class="n">myxmpp</span><span class="p">]</span>
<span class="n">Server</span><span class="o">=</span><span class="s2">&quot;fqdn.of.your.OSP.Server:5222&quot;</span>
<span class="c1">#Jid your userid</span>
<span class="n">Jid</span><span class="o">=</span><span class="s2">&quot;OSPUserName@yourserver.tld&quot;</span>
<span class="n">Password</span><span class="o">=</span><span class="s2">&quot;PasswordFromUserSettings&quot;</span>
<span class="n">Muc</span><span class="o">=</span><span class="s2">&quot;conference.your.fqdn&quot;</span>
<span class="n">Nick</span><span class="o">=</span><span class="s2">&quot;YourFriendlyUserName&quot;</span>
<span class="n">RemoteNickFormat</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{PROTOCOL}</span><span class="s2">-[</span><span class="si">{NICK}</span><span class="s2">] &quot;</span>
<span class="p">[[</span><span class="n">gateway</span><span class="p">]]</span>
<span class="n">name</span><span class="o">=</span><span class="s2">&quot;gateway1&quot;</span>
<span class="n">enable</span><span class="o">=</span><span class="n">true</span>
<span class="p">[[</span><span class="n">gateway</span><span class="o">.</span><span class="n">inout</span><span class="p">]]</span>
<span class="n">account</span><span class="o">=</span><span class="s2">&quot;irc.twitch&quot;</span>
<span class="n">channel</span><span class="o">=</span><span class="s2">&quot;#YourTwitchChannel&quot;</span>
<span class="p">[[</span><span class="n">gateway</span><span class="o">.</span><span class="n">inout</span><span class="p">]]</span>
<span class="n">account</span><span class="o">=</span><span class="s2">&quot;xmpp.myxmpp&quot;</span>
<span class="n">channel</span><span class="o">=</span><span class="s2">&quot;YourOSPChannelUID&quot;</span>
<span class="p">[[</span><span class="n">gateway</span><span class="o">.</span><span class="n">inout</span><span class="p">]]</span>
<span class="n">account</span><span class="o">=</span><span class="s2">&quot;discord.mydiscord&quot;</span>
<span class="n">channel</span><span class="o">=</span><span class="s2">&quot;ChannelNameYouWantToSendTo&quot;</span>
</pre></div>
</div>
<p>Test your configuration by starting matterbridge.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">matterbridge</span> <span class="o">-</span><span class="n">debug</span> <span class="o">-</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
<p>If all went well, create a service for matterbridge to run as.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>Paste the following and save the file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">matterbridge</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>
<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">matterbridge</span> <span class="o">-</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">.</span><span class="n">toml</span>
<span class="n">User</span><span class="o">=</span><span class="n">matterbridge</span>
<span class="n">Group</span><span class="o">=</span><span class="n">matterbridge</span>
<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Enable and run the service</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">matterbridge</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">matterbridge</span>
</pre></div>
</div>
<p>Set the service to run at startup</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">matterbridge</span>
</pre></div>
</div>
<p>You should now have a fully integrated chat with Twitch, OSP and Discord.</p>
</section>
<section id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline"></a></h4>
<p>The two files that will be most important are the ejabberd log and the debug of the matterbridge service.
OSP Server</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Matterbridge Server re-run the matterbridge application with the -debug flag</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">matterbridge</span> <span class="o">-</span><span class="n">debug</span> <span class="o">-</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">/</span><span class="n">matterbridge</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="manually-configuring-certificates-if-auto-creation-is-not-functioning">
<h4>Manually configuring certificates if auto creation is not functioning<a class="headerlink" href="#manually-configuring-certificates-if-auto-creation-is-not-functioning" title="Permalink to this headline"></a></h4>
<p>If the automated acme-challenge isnt working for one reason or another, you can create a cert and assign it manually. Run this command replacing subdomain.domain.tld with your fqdn</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">certbot</span> <span class="n">certonly</span> <span class="o">--</span><span class="n">manual</span> <span class="o">-</span><span class="n">d</span> <span class="n">conference</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span> <span class="o">-</span><span class="n">d</span> <span class="n">proxy</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span> <span class="o">-</span><span class="n">d</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span> <span class="o">-</span><span class="n">d</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">tld</span> <span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">bootstrap</span> <span class="o">--</span><span class="n">manual</span><span class="o">-</span><span class="n">public</span><span class="o">-</span><span class="n">ip</span><span class="o">-</span><span class="n">logging</span><span class="o">-</span><span class="n">ok</span> <span class="o">--</span><span class="n">preferred</span><span class="o">-</span><span class="n">challenges</span> <span class="n">dns</span><span class="o">-</span><span class="mi">01</span> <span class="o">--</span><span class="n">server</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">acme</span><span class="o">-</span><span class="n">v02</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">letsencrypt</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">directory</span>
</pre></div>
</div>
<p>Create txt records on your dns when asked. You will require a txt record for each subdomain.
Combine the full chain you create with the private key</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">yoursite</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">yoursite</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span> <span class="o">&gt;</span> <span class="o">~/</span><span class="n">combined</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>Move your newly created combined pem file to a better location (something like /etc/ssl/ejabberd)
Uncomment the following lines in /usr/local/ejabberd/conf/ejabberd.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certfiles</span><span class="p">:</span>
</pre></div>
</div>
<p>Add directly beneath</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">ejabberd</span><span class="o">/</span><span class="n">combined</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>Be SURE to line up your - /etc with the rest of the dashes in the yml file. YAML is very picky about spacing. It must tbe exact.</p>
</section>
<section id="let-s-encrypt-setup">
<h4>Let’s Encrypt Setup<a class="headerlink" href="#let-s-encrypt-setup" title="Permalink to this headline"></a></h4>
<p>The focus of this guide will be to provide an example of how to setup SSL with LetsEncrypt and Certbot.
For this example we are using a default install of OSP on Ubuntu 20.04 (or 18.04) LTS</p>
<section id="step-one-install-certbot">
<h5>Step one, install Certbot<a class="headerlink" href="#step-one-install-certbot" title="Permalink to this headline"></a></h5>
<p>Install certbot (running with Nginx) as described at https://certbot.eff.org/instructions
Installion of certbot in short (for most systems) works with snap as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sudo snap install core; sudo snap refresh core</span>
<span class="c1"># sudo snap install --classic certbot</span>
<span class="c1"># sudo ln -s /snap/bin/certbot /usr/bin/certbot</span>
</pre></div>
</div>
<p>Verify certbot is installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># certbot --version</span>
<span class="n">certbot</span> <span class="mf">1.13.0</span>
</pre></div>
</div>
</section>
<section id="create-a-location-for-certbot-verification-outside-of-the-actual-webroot">
<h5>Create a location for certbot verification outside of the actual webroot<a class="headerlink" href="#create-a-location-for-certbot-verification-outside-of-the-actual-webroot" title="Permalink to this headline"></a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkdir /var/certbot</span>
<span class="c1"># chmod 755 /var/certbot</span>
</pre></div>
</div>
<p>Edit the OSP nginx config to use this location for the certbot verification by adding the following lines to /usr/local/nginx/conf/nginx.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span> <span class="p">{</span>
<span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">certbot</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These lines should go under your port 80 server, in my config I put them right below the line “include /usr/local/nginx/conf/locations/*.conf;”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># NGINX to HTTP Reverse Proxies</span>
<span class="n">server</span> <span class="p">{</span>
<span class="n">include</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span><span class="n">osp</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">servers</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>
<span class="c1"># set client body size to 16M #</span>
<span class="n">client_max_body_size</span> <span class="mi">16</span><span class="n">M</span><span class="p">;</span>
<span class="n">include</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">locations</span><span class="o">/*.</span><span class="n">conf</span><span class="p">;</span>
<span class="n">location</span> <span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span> <span class="p">{</span>
 <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">certbot</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1"># redirect server error pages to the static page /50x.html</span>
<span class="n">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="mi">50</span><span class="n">x</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
<span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="mi">50</span><span class="n">x</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span>
<span class="n">root</span> <span class="n">html</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="n">include</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span><span class="n">osp</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">serversredirect</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="restart-nginx">
<h5>Restart Nginx<a class="headerlink" href="#restart-nginx" title="Permalink to this headline"></a></h5>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">nginx-osp</span></code></p>
</section>
<section id="run-certbot-to-request-certs-from-letsencrypt">
<h5>Run certbot to request certs from LetsEncrypt<a class="headerlink" href="#run-certbot-to-request-certs-from-letsencrypt" title="Permalink to this headline"></a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sudo certbot certonly --webroot -w /var/certbot -d &lt;domain&gt;</span>
</pre></div>
</div>
<p>This command will prompt you for a few pieces of information and then it will save your certs in /etc/letsencrypt/live/</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- Congratulations! Your certificate and chain have been saved at:
/etc/letsencrypt/live/&lt;domain&gt;/fullchain.pem
Your key file has been saved at:
/etc/letsencrypt/live/&lt;domain&gt;/privkey.pem
Your cert will expire on &lt;date&gt;. To obtain a new or tweaked
version of this certificate in the future, simply run certbot
again. To non-interactively renew *all* of your certificates, run
&quot;certbot renew&quot;
</pre></div>
</div>
</section>
<section id="configure-nginx-osp-to-use-ssl-and-the-certificates-you-have-requested">
<h5>Configure nginx-osp to use SSL and the certificates you have requested<a class="headerlink" href="#configure-nginx-osp-to-use-ssl-and-the-certificates-you-have-requested" title="Permalink to this headline"></a></h5>
<p>Edit /usr/local/nginx/conf/custom/osp-custom-servers.conf and edit the section to similar to below:
Remember to change your domain name and certificate location to match the step above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#listen 80 default_server;</span>
<span class="c1">### Comment Above and Uncomment/Edit Below for OSP-Proxy TLS ###</span>
<span class="n">listen</span> <span class="mi">443</span> <span class="n">ssl</span> <span class="n">http2</span> <span class="n">default_server</span><span class="p">;</span>
<span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">osp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="n">ssl_protocols</span> <span class="n">TLSv1</span><span class="mf">.2</span> <span class="n">TLSv1</span><span class="mf">.3</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="configure-nginx-osp-to-do-http-to-https-redirect">
<h5>Configure nginx-osp to do http to https redirect<a class="headerlink" href="#configure-nginx-osp-to-do-http-to-https-redirect" title="Permalink to this headline"></a></h5>
<p>Uncomment all lines in /usr/local/nginx/conf/custom/osp-custom-serversredirect.conf to read as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>server {
listen 80;
server_name _;
return 301 https://$host$request_uri;
}
</pre></div>
</div>
<p>Restart nginx.osp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sudo systemctl restart nginx-osp</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="haproxy-load-balancing">
<h2>HAProxy Load Balancing<a class="headerlink" href="#haproxy-load-balancing" title="Permalink to this headline"></a></h2>
<section id="pre-requisites">
<h3>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline"></a></h3>
<p>This guide is designed for people running OSP Split server and <strong>not</strong> single server installations. This guide assumes that you currently have a working setup with at least 1 core server.
Tested working on Ubuntu 20.04 (LTS) on 2021.10.11. VPS Spec: 2GB RAM, 1 vCPU and 50GB Disk. Cloud Provider: Digital Ocean. For SSL installation your FQDN must be pointing at your HAProxy Server IP Address.
To Install, do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">upgrade</span>
<span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">haproxy</span>
<span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">certbot</span>
</pre></div>
</div>
<p>After installing run haproxy -v to confirm installed and working as intended. You should get an output like:
HA-Proxy version 2.0.13-2ubuntu0.3 2021/08/27 - https://haproxy.org/</p>
</section>
<section id="setup-config-file">
<h3>Setup Config File<a class="headerlink" href="#setup-config-file" title="Permalink to this headline"></a></h3>
<p>Once the install is done you can then configure the Config file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>Under the defaults section, enter the following lines, replacing words (and the dashes) with your own information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">frontend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">frontend</span> <span class="n">http</span><span class="o">--</span>
<span class="c1"># Define Port to Bind To and set the mode</span>
<span class="n">bind</span> <span class="p">:</span><span class="mi">80</span>
<span class="n">bind</span> <span class="p">:::</span><span class="mi">80</span>
<span class="n">mode</span> <span class="n">http</span>
<span class="c1"># Used to redirect HTTP Requests to HTTPS</span>
<span class="c1"># http-request redirect scheme https unless { ssl_fc }</span>
<span class="c1"># Enable this if you want to view stats</span>
<span class="c1"># stats uri /haproxy?stats</span>
<span class="c1"># Sets the default backend for servers</span>
<span class="n">default_backend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">below</span> <span class="n">backend</span> <span class="p">(</span><span class="n">MUST</span> <span class="n">MATCH</span><span class="p">)</span><span class="o">--</span>
<span class="c1"># Certbot SSL Installation</span>
<span class="n">acl</span> <span class="n">is_certbot</span> <span class="n">path_beg</span> <span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span><span class="o">/</span>
<span class="n">use_backend</span> <span class="n">backend</span><span class="o">-</span><span class="n">certbot</span> <span class="k">if</span> <span class="n">is_certbot</span>
<span class="c1">#frontend --name to define frontend https--</span>
<span class="c1"># bind :443 ssl crt /etc/haproxy/ssl/</span>
<span class="c1"># bind :::443 ssl crt /etc/haproxy/ssl/</span>
<span class="c1"># mode http</span>
<span class="c1"># ACL for detecting Let&#39;s Encrypt validtion requests</span>
<span class="c1"># acl is_certbot path_beg /.well-known/acme-challenge/</span>
<span class="c1"># use_backend backend-certbot if is_certbot</span>
<span class="c1"># default_backend --name to define below backend (MUST MATCH)--</span>
<span class="n">backend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">below</span> <span class="n">backend</span> <span class="p">(</span><span class="n">MUST</span> <span class="n">MATCH</span> <span class="n">ABOVE</span> <span class="n">default_backed</span><span class="p">)</span><span class="o">--</span>
<span class="n">mode</span> <span class="n">http</span>
<span class="n">balance</span> <span class="n">leastconn</span>
<span class="n">server</span> <span class="o">--</span><span class="n">yourservername</span><span class="o">--</span> <span class="o">--</span><span class="n">server</span> <span class="n">internal</span> <span class="ow">or</span> <span class="n">public</span> <span class="n">ip</span><span class="o">--</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">3</span> <span class="n">fall</span> <span class="mi">2</span>
<span class="n">backend</span> <span class="n">backend</span><span class="o">-</span><span class="n">certbot</span>
<span class="n">server</span> <span class="n">letsencrypt</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">9080</span>
</pre></div>
</div>
<p>Once that is done run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">reload</span> <span class="n">haproxy</span>
</pre></div>
</div>
<p>The above config will get you running with HTTP. You must make sure that the default_backend under http and https match the backend name in the non backend-certbot section or haproxy wont start. You can change the server checks yourself but the above will check each core server every 5 seconds for a response. It it fails twice it will not use that server in the balancer.
If you want to be able to view your haproxy stats you can uncomment line 9 above and run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">reload</span> <span class="n">haproxy</span>
</pre></div>
</div>
<p>You can then go to http://haproxyipaddress/fqdn/haproxy?stats or http://fqdn/haproxy?stats</p>
</section>
<section id="ssl-setup">
<h3>SSL Setup<a class="headerlink" href="#ssl-setup" title="Permalink to this headline"></a></h3>
<p>In order to setup SSL Using LetsEncrypt your FQDN must be pointing to the public IP address of your haproxy server. You also need to have certbot installed.
Run the following, replacing mydomain.com with your FQDN and me&#64;mydomain.com with your email address. You should get a message saying that your certificate and chain have been saved etc.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certbot</span> <span class="n">certonly</span> <span class="o">--</span><span class="n">standalone</span> <span class="o">--</span><span class="n">preferred</span><span class="o">-</span><span class="n">challenges</span> <span class="n">http</span> <span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">address</span> <span class="mf">127.0.0.1</span> <span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">port</span> <span class="mi">9080</span> <span class="o">-</span><span class="n">d</span> <span class="n">mydomain</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">email</span> <span class="n">me</span><span class="nd">@mydomain</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span> <span class="o">--</span><span class="n">non</span><span class="o">-</span><span class="n">interactive</span>
</pre></div>
</div>
<p>We then need to combine those files into one for haproxy.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">prepareLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Then add the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
# Loop through all Let&#39;s Encrypt certificates
for CERTIFICATE in `find /etc/letsencrypt/live/* -type d`; do
CERTIFICATE=`basename $CERTIFICATE`
# Combine certificate and private key to single file
cat /etc/letsencrypt/live/$CERTIFICATE/fullchain.pem /etc/letsencrypt/live/$CERTIFICATE/privkey.pem &gt; /etc/haproxy/ssl/$CERTIFICATE.pem
done
</pre></div>
</div>
<p>Create the SSL Directory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">ssl</span>
</pre></div>
</div>
<p>Execute all the things!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">prepareLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">prepareLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>If the above has all gone well you should now be able to edit your haproxy config file and enable SSL by uncommenting the following lines in the config below (copied from above):
Line 7 - if you want to force SSL
Lines 16-19
Lines 21-23</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">frontend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">frontend</span> <span class="n">http</span><span class="o">--</span>
<span class="c1"># Define Port to Bind To and set the mode</span>
<span class="n">bind</span> <span class="p">:</span><span class="mi">80</span>
<span class="n">bind</span> <span class="p">:::</span><span class="mi">80</span>
<span class="n">mode</span> <span class="n">http</span>
<span class="c1"># Used to redirect HTTP Requests to HTTPS</span>
<span class="c1"># http-request redirect scheme https unless { ssl_fc }</span>
<span class="c1"># Enable this if you want to view stats</span>
<span class="c1"># stats uri /haproxy?stats</span>
<span class="c1"># Sets the default backend for servers</span>
<span class="n">default_backend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">below</span> <span class="n">backend</span> <span class="p">(</span><span class="n">MUST</span> <span class="n">MATCH</span><span class="p">)</span><span class="o">--</span>
<span class="c1"># Certbot SSL Installation</span>
<span class="n">acl</span> <span class="n">is_certbot</span> <span class="n">path_beg</span> <span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span><span class="o">/</span>
<span class="n">use_backend</span> <span class="n">backend</span><span class="o">-</span><span class="n">certbot</span> <span class="k">if</span> <span class="n">is_certbot</span>
<span class="c1">#frontend --name to define frontend https--</span>
<span class="c1"># bind :443 ssl crt /etc/haproxy/ssl/</span>
<span class="c1"># bind :::443 ssl crt /etc/haproxy/ssl/</span>
<span class="c1"># mode http</span>
<span class="c1"># ACL for detecting Let&#39;s Encrypt validtion requests</span>
<span class="c1"># acl is_certbot path_beg /.well-known/acme-challenge/</span>
<span class="c1"># use_backend backend-certbot if is_certbot</span>
<span class="c1"># default_backend --name to define below backend (MUST MATCH)--</span>
<span class="n">backend</span> <span class="o">--</span><span class="n">name</span> <span class="n">to</span> <span class="n">define</span> <span class="n">below</span> <span class="n">backend</span> <span class="p">(</span><span class="n">MUST</span> <span class="n">MATCH</span> <span class="n">ABOVE</span> <span class="n">default_backed</span><span class="p">)</span><span class="o">--</span>
<span class="n">mode</span> <span class="n">http</span>
<span class="n">balance</span> <span class="n">leastconn</span>
<span class="n">server</span> <span class="o">--</span><span class="n">yourservername</span><span class="o">--</span> <span class="o">--</span><span class="n">server</span> <span class="n">internal</span> <span class="ow">or</span> <span class="n">public</span> <span class="n">ip</span><span class="o">--</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">5</span><span class="n">s</span> <span class="n">rise</span> <span class="mi">3</span> <span class="n">fall</span> <span class="mi">2</span>
<span class="n">backend</span> <span class="n">backend</span><span class="o">-</span><span class="n">certbot</span>
<span class="n">server</span> <span class="n">letsencrypt</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">9080</span>
</pre></div>
</div>
</section>
<section id="automatic-certificate-renewals-and-file-merging">
<h3>Automatic Certificate Renewals and File Merging<a class="headerlink" href="#automatic-certificate-renewals-and-file-merging" title="Permalink to this headline"></a></h3>
<p>Create a script to automate the certbot renewal and then merge the files and reload haproxy.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">renewLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Then Add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="n">certbot</span> <span class="n">renew</span> <span class="o">--</span><span class="n">standalone</span> <span class="o">--</span><span class="n">preferred</span><span class="o">-</span><span class="n">challenges</span> <span class="n">http</span> <span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">address</span> <span class="mf">127.0.0.1</span> <span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">port</span> <span class="mi">9080</span> <span class="o">--</span><span class="n">post</span><span class="o">-</span><span class="n">hook</span> <span class="s2">&quot;/etc/haproxy/prepareLetsEncryptCertificates.sh &amp;&amp; systemctl reload haproxy.service&quot;</span> <span class="o">--</span><span class="n">quiet</span>
</pre></div>
</div>
<p>And make it executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">renewLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Create a cronjob to get the script to check for certificate renewals and run the certificate merge:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">renewLetsEncryptCertificates</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Job done!</p>
</section>
<section id="lock-down-stats-page">
<h3>Lock Down Stats Page<a class="headerlink" href="#lock-down-stats-page" title="Permalink to this headline"></a></h3>
<p>If you want the stats page to be active then haproxy have a good blog post on how to lock it down and also what all of the metrics mean below:
https://www.haproxy.com/blog/exploring-the-haproxy-stats-page/</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../overview/attribution.html" class="btn btn-neutral float-left" title="Attribution" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="upgrades.html" class="btn btn-neutral float-right" title="Upgrades" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Open Streaming Platform.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>